<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="//cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
    <script src="//cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>

    <title>Document</title>
    <style type="text/css">
      #result_card img {
        max-width: 100%;
        height: auto;
        display: block;
        padding: 5px;
        margin-top: 10px;
        margin: auto;
      }
      #result_card {
        position: relative;
      }
      .imgDeleteBtn {
        position: absolute;
        top: 0;
        right: 5%;
        background-color: #ef7d7d;
        color: wheat;
        font-weight: bold;
        width: 30px;
        height: 30px;
        border-radius: 26px;
        text-align: center;
        border: none;
        display: block;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="form_section">
      <div class="form_section_title">
        <label>상품 이미지</label>
      </div>
      <div class="form_section_content">
        <input
          type="file"
          multiple="true"
          name="uploadFile"
          style="height: 30px"
        />
        <div id="uploadResult">
          <!-- <div id="result_card">
            <div class="imgDeleteBtn">XX</div>
            <img src="/display?fileName=test.png"/>
          </div> -->
        </div>
      </div>
    </div>
    <button class="maps" onclick="map_popup()">
      거래가능한 위치 지도로 표시
    </button>
  </body>
  <script>
    function map_popup() {
      window.open('/map_popup', '지도', 'width=1000, height=600');
    }
  </script>
  <script>
    $("input[type='file']").on('change', function (e) {
      let formData = new FormData();
      let fileInput = $('input[name="uploadFile"]');
      let fileList = fileInput[0].files;
      let fileObj = fileList[0];

      console.log('filelist :' + fileList);
      console.log('fileObj: ' + fileObj);
      console.log('fileName : ' + fileObj.name);
      console.log('fileSize : ' + fileObj.size);
      console.log('fileType(MimeType) : ' + fileObj.type);
      let fileName = fileObj.name;
      let fileSize = fileObj.size;
      let fileType = fileObj.type;

      if (!fileCheck(fileObj.name, fileObj.size)) {
        return false;
      }

      for (let i = 0; i < fileList.length; i++) {
        formData.append('uploadFile', fileList[i]);
      }

      $.ajax({
        url: '/uploadTest',
        processData: false,
        contentType: false,
        data: formData,
        type: 'POST',
        dataType: 'json',
        success: function (result) {
          console.log(result);
          showUploadImage(result);
        },
        error: function (result) {
          alert('이미지 파일이 아닙니다');
        },
      });
    });

    let regex = new RegExp('(.*?)\.(jpg|png)$');
    let maxSize = 51048576;

    function fileCheck(fileName, fileSize) {
      if (fileSize >= maxSize) {
        alert('파일 사이즈 초과');
        return false;
      }
      if (!regex.test(fileName)) {
        alert('파일명 오류');
        return false;
      }
      return true;
    }
    // 이미지 출력
    function showUploadImage(uploadResultArr) {
      if (!uploadResultArr || uploadResultArr.length == 0) {
        return;
      }

      let uploadResult = $('#uploadResult');
      let obj = uploadResultArr[0];

      let str = '';
      let fileCallPath = encodeURIComponent(
        obj.uploadPath + '/s_' + obj.uuid + '_' + obj.fileName,
      );
      console.log(obj.uploadPath);
      console.log(obj.uuid);
      console.log(obj.fileName);
      // let fileCallPath = encodeURIComponent(obj.uploadPath.replace(/\\/g, '/') + "/s_" + obj.uuid + "_" + obj.fileName);

      str += "<div id='result_card'>";
      str += "<img src='/display?fileName=" + fileCallPath + "'>";
      str += "<div class='imgDeleteBtn'>XX<div>";
      str += '</div>';

      uploadResult.append(str);
    }
  </script>
</html>

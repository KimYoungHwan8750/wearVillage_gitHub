<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="//cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
    <script src="//cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>

    <title>Document</title>
    <style type="text/css">
      #result_card img {
        max-width: 100%;
        height: auto;
        display: block;
        padding: 5px;
        margin-top: 10px;
        margin: auto;
      }
      #result_card {
        position: relative;
      }
      .imgDeleteBtn {
        position: absolute;
        top: 0;
        right: 5%;
        background-color: #ef7d7d;
        color: wheat;
        font-weight: bold;
        width: 30px;
        height: 30px;
        border-radius: 26px;
        text-align: center;
        border: none;
        display: block;
        cursor: pointer;
      }
      .ql-toolbar {
        width: 1000px;
      }
    </style>
  </head>
  <body>
    <div class="post_writer">
      <input
        type="text"
        id="post_writer_id_id"
        style="width: 200px"
        value="작성자ID"
      />
    </div>
    <div class="post_subtitle">
      <input
        type="text"
        id="post_subtitle_id"
        style="
          width: 1000px;
          height: 40px;
          font-size: 18px;
          line-height: 40px;
          padding: 0px;
        "
      />
    </div>
    <div id="editor" style="width: 1000px; height: 600px"></div>
    <input type="hidden" id="content_id" name="content" />
    <div class="form_section">
      <div class="form_section_title"></div>
      <!-- <div class="form_section_content">
        <input
          type="file"
          multiple="true"
          name="uploadFile"
          style="height: 30px"
        />
        <div id="uploadResult"></div>
      </div> -->
    </div>
    <button class="maps" onclick="map_popup()">
      거래가능한 위치 지도로 표시
    </button>
    <button id="toOracle_btn" type="button" value="오라클로 보내기">
      보내용
    </button>
    <button id="post_post_id" type="button" value="작성하기">작성하기</button>
  </body>

  <!-- 작성 버튼 시작 -->
  <script>
    let POST_ID;
    let POST_WRITER_ID;
    let POST_SUBTITLE;
    let POST_TEXT;
    let POST_DATE;
    let POST_MODIFY_DATE;

    let today = new Date();

    $('#post_post_id').on('click', function () {
      POST_ID = '123번';
      POST_WRITER_ID = $('#post_writer_id').val();
      POST_SUBTITLE = $('#post_subtitle_id').val();
      console.log(POST_SUBTITLE);
      POST_TEXT = $('.ql-editor').val();
      console.log('포스트텍스트' + quill.container.firstChild.innerHTML);
      POST_DATE =
        today.getFullYear() +
        '년' +
        (today.getMonth() + 1) +
        '월' +
        today.getDate() +
        '일';
      POST_MODIFY_DATE = '1234수정일';

      let postData = {
        postId: '1',
        // postWriterId: $('#post_writer_id').val(),
        postWriterId:'2',
        postSubtitle: $('#post_subtitle_id').val(),
        postText: quill.container.firstChild.innerHTML,
        postDate: today.getFullYear() +
        '년' +
        (today.getMonth() + 1) +
        '월' +
        today.getDate() +
        '일',
        postModifyDate:'수정일자없음'
      };

      $.ajax({
        type: 'POST',
        url: '/postToOracle',
        data: JSON.stringify(postData),
        contentType: 'application/json',
        success: function (response) {
          console.log('Success');
          // window.location.href = ''; 이동위치
        },
        error: function (error) {
          console.log('Error');
          // Handle error here
        },
      });
    });
  </script>
  <!-- 작성 버튼 끝 -->

  <!-- 퀼 시작 -->
  <script>
    function quilljsediterInit() {
      var option = {
        modules: {
          toolbar: [
            [{ header: [1, 2, false] }],
            ['bold', 'italic', 'underline'],
            ['image', 'code-block'],
            [{ list: 'ordered' }, { list: 'bullet' }],
          ],
        },
        placeholder: '자세한 내용을 입력해 주세요!',
        theme: 'snow',
      };

      quill = new Quill('#editor', option);
      // quill.on('text-change', function () {
      //   document.getElementById('quill_html').value =
      //     quill.container.firstChild.innerHTML;
      // });
      quill.on('text-change', () => {
        document.getElementsByClassName('ql-editor').value =
          quill.container.firstChild.innerHTML;

      });

      // Add custom image handler
      quill.getModule('toolbar').addHandler('image', function () {
        const fileInput = document.createElement('input');
        fileInput.setAttribute('type', 'file');
        fileInput.setAttribute('accept', '.jpg,.png'); // Accept only images
        fileInput.click();

        // Listen for file input change events
        fileInput.addEventListener('change', function () {
          if (fileInput.files != null && fileInput.files[0] != null) {
            let formData = new FormData();

            for (let i = 0; i < fileInput.files.length; i++) {
              formData.append('uploadFile', fileInput.files[i]);
            }

            $.ajax({
              url: '/uploadTest',
              processData: false,
              contentType: false,
              data: formData,
              type: 'POST',
              dataType: 'json',

              success: function (result) {
                console.log('Success', result);
                showUploadImage(result);

                let range = quill.getSelection(true);

                for (let i = 0; i < result.length; i++) {
                  let obj = result[i];
                  let filePath =
                    obj.uploadPath.replace(/\\/g, '/') +
                    '/s_' +
                    obj.uuid +
                    '_' +
                    obj.fileName;
                  filePath = encodeURIComponent(filePath);

                  // Insert uploaded image to the editor
                  quill.insertEmbed(
                    range.index,
                    'image',
                    '/display?fileName=' + filePath,
                  );

                  range.index++;
                }
              },
              error: function (error) {
                console.log('Error:', error);
              },
            });
          }
        });
      });
    }

    quilljsediterInit();
  </script>
  <!-- 퀼 끝 -->

  <!-- 지도 시작 -->
  <script>
    function map_popup() {
      window.open('/map_popup', '지도', 'width=1000, height=600');
    }
  </script>
  <!-- 지도 끝 -->
  <script>
    $("input[type='file']").on('change', function (e) {
      if ($('.imgDeleteBtn').length > 0) {
        deleteFile();
      }
      // 삭제펑션

      let formData = new FormData();
      let fileInput = $('input[name="uploadFile"]');
      let fileList = fileInput[0].files;
      let fileObj = fileList[0];

      console.log('filelist :' + fileList);
      console.log('fileObj: ' + fileObj);
      console.log('fileName : ' + fileObj.name);
      console.log('fileSize : ' + fileObj.size);
      console.log('fileType(MimeType) : ' + fileObj.type);
      let fileName = fileObj.name;
      let fileSize = fileObj.size;
      let fileType = fileObj.type;

      if (!fileCheck(fileObj.name, fileObj.size)) {
        return false;
      }

      for (let i = 0; i < fileList.length; i++) {
        formData.append('uploadFile', fileList[i]);
      }

      $.ajax({
        url: '/uploadTest',
        processData: false,
        contentType: false,
        data: formData,
        type: 'POST',
        dataType: 'json',
        success: function (result) {
          console.log('Success', result);
          showUploadImage(result);
        },
        error: function (error) {
          console.log('Error:', error);
        },
        // error: function (result) {
        //   alert('이미지 파일이 아닙니다');
        // },
      });
    });

    let regex = new RegExp('(.*?)\.(jpg|png)$');
    let maxSize = 51048576;

    function fileCheck(fileName, fileSize) {
      if (fileSize >= maxSize) {
        alert('파일 사이즈 초과');
        return false;
      }
      if (!regex.test(fileName)) {
        alert('파일명 오류');
        return false;
      }
      return true;
    }

    // 이미지 출력

    let images = [];

    function showUploadImage(uploadResultArr) {
      if (!uploadResultArr || uploadResultArr.length == 0) {
        return;
      }

      let uploadResult = $('#uploadResult');

      for (let i = 0; i < uploadResultArr.length; i++) {
        let obj = uploadResultArr[i];

        let str = '';

        images.push({
          uploadPath: obj.uploadPath.replace(/\\/g, '/'),
          uuid: obj.uuid,
          fileName: obj.fileName,
        });

        $('#toOracle_btn').on('click', function () {
          $.ajax({
            url: '/letsgo_oracle',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(images), // Send the entire array
          });
        });

        let fileCallPath = encodeURIComponent(
          obj.uploadPath.replace(/\\/g, '/') +
            '/s_' +
            obj.uuid +
            '_' +
            obj.fileName,
        );

        // let fileCallPath = encodeURIComponent(
        //   obj.uploadPath.replace(/\\/g, '/').replace('C:/upload/', '') +
        //     '/s_' +
        //     obj.uuid +
        //     '_' +
        //     obj.fileName,
        // );
        console.log(obj.uploadPath);
        console.log(obj.uuid);
        console.log(obj.fileName);

        str += "<div id='result_card'>";
        str += "<img src='/display?fileName=" + fileCallPath + "'>";
        str +=
          "<div class='imgDeleteBtn' data-file='" + fileCallPath + "'>x<div>";
        str += '</div>';

        uploadResult.append(str);
      }
    }

    $('#uploadResult').on('click', '.imgDeleteBtn', function (e) {
      deleteFile();
    });

    function deleteFile() {
      let targetFile = $('.imgDeleteBtn').data('file');
      let targetDiv = $('#result_card');
      $.ajax({
        url: '/deleteFile',
        data: { fileName: targetFile },
        dataType: 'text',
        type: 'POST',
        success: function (result) {
          console.log(result);
          targetDiv.remove();
          $("input[type='file']").val('');
        },
        error: function (result) {
          console.log(result);
          alert('파일 삭제 실패');
        },
      });
    }
  </script>
</html>

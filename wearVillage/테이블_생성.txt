/*계정 생성*/
DROP USER c##wearVillage CASCADE;
CREATE USER c##wearVillage IDENTIFIED BY wearVillage DEFAULT TABLESPACE users TEMPORARY TABLESPACE temp PROFILE DEFAULT;
GRANT CONNECT, RESOURCE TO c##wearVillage;
GRANT CREATE VIEW, CREATE SYNONYM TO c##wearVillage;
GRANT UNLIMITED TABLESPACE TO c##wearVillage;
ALTER USER c##wearVillage ACCOUNT UNLOCK;
/*테이블 생성*/
ALTER TABLE ChatMessage
DROP CONSTRAINT SENDER_ID_FK;
ALTER TABLE ChatMessage
DROP CONSTRAINT RECEIVER_ID_FK;
ALTER TABLE USERINFO
DROP PRIMARY KEY;

DROP TABLE USERINFO;
DROP TABLE ChatMessage;

CREATE TABLE USERINFO (
    ID VARCHAR2(20),
    PASSWORD VARCHAR2(20),
    EMAIL VARCHAR2(40)    
);

CREATE TABLE ChatMessage (
    MESSAGE_ID NUMBER,
    SENDER_ID VARCHAR2(20),
    RECEIVER_ID VARCHAR2(20),
    CONTENT VARCHAR2(1000),
    TIMESTAMP TIMESTAMP
);

ALTER TABLE USERINFO
ADD CONSTRAINT USERINFO_ID_PK PRIMARY KEY (ID);

ALTER TABLE ChatMessage
ADD CONSTRAINT SENDER_ID_FK
FOREIGN KEY (SENDER_ID)
REFERENCES USERINFO (ID);

ALTER TABLE ChatMessage
ADD CONSTRAINT RECEIVER_ID_FK
FOREIGN KEY (RECEIVER_ID)
REFERENCES USERINFO (ID);




/*서버 테이블*/

CREATE TABLE CLOTH_IMAGE (
	FILENAME varchar2(100) not null,
	UPLOADPATH varchar2(200) not null,
	UUID varchar2(100) not null
)

CREATE TABLE POSTING_TABLE (
   POST_ID NUMBER PRIMARY KEY,
   POST_WRITER_ID VARCHAR2(30) not null,
   POST_SUBTITLE VARCHAR2(100) not null,
   POST_PRICE VARCHAR2(30) not null,
    POST_RENT_DEFAULT_PRICE VARCHAR2(30) ,
    POST_RENT_DAY_PRICE VARCHAR2(30) ,
   POST_TAG_TOP VARCHAR2(30) not null,
    POST_TAG_MIDDLE VARCHAR2(30) not null,
   POST_MAP_INFO VARCHAR2(100) not null,
   POST_TEXT LONG not null,
    POST_IMAGE VARCHAR2(200),
   POST_DATE VARCHAR2(100) not null,
   POST_MODIFY_DATE  VARCHAR2(100)   
)



/* 채팅 테이블*/
CREATE TABLE USER_CHAT(
	USER_ID varChar2(40),
	TARGET_ID varChar2(40),
	MESSAGE varChar2(1500),
	CHAT_ID varChar2(40),
	POST_ID NUMBER
)


/*유저 인포*/
CREATE TABLE USER_INFO(
	ID varChar2(40) PRIMARY KEY,
	PW varChar2(40),
	NICKNAME varChar2(20),
	EMAIL varChar2(60),
	PROFILEIMG varChar2(400),
	THEME varChar2(20),
	GENDER varChar2(10),
	BIRTH varChar2(20)
)



DROP TABLE USER_CHAT;
CREATE TABLE USER_CHAT(
                          CHAT_NUM NUMBER,
                          SENDER varChar2(60),
                          ADDRESSEE varChar2(60),
                          MESSAGE varChar2(1500),
                          CHATROOM NUMBER,
                          CHAT_DATE TIMESTAMP
);

DROP TABLE CHAT_ROOM;
CREATE TABLE CHAT_ROOM(
    POST_ID NUMBER,
    MEMBER1 varChar2(60),
    MEMBER2 varChar2(60),
    RECENTLY_MSG varChar2(1500)
);

-- 최근 메세지 트리거
create trigger RECENTLY_MSG_TRIGGER
    after insert
    on USER_CHAT
    for each row
DECLARE

BEGIN
    UPDATE CHAT_ROOM
    SET RECENTLY_MSG = :NEW.MESSAGE, RECENTLY_TIME = :NEW.CHAT_DATE
    WHERE POST_ID = :NEW.CHATROOM AND (MEMBER1 = :NEW.SENDER OR MEMBER2 = :NEW.SENDER);
END;
/

-- 날짜 자동 삽입 트리거
CREATE OR REPLACE TRIGGER AUTO_DATE_TRIGGER BEFORE INSERT ON USER_CHAT FOR EACH ROW
DECLARE

BEGIN
    :NEW.CHAT_DATE := SYSTIMESTAMP;
END;

-- 테스트 쿼리
INSERT INTO USER_CHAT (CHAT_NUM,SENDER,ADDRESSEE,MESSAGE,CHATROOM) VALUES(10,'test','test2','123',5);

INSERT INTO USER_CHAT VALUES(1,'test','test2','1234',5,null);
